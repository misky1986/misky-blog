# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

variables:
  hugo.version: '0.62.0'
  hugo.theme.path: 'themes/mind-blown'
  vmImage: 'ubuntu-latest'
  tag: '$(Build.BuildNumber)'

stages:
- stage: DownloadAndInstallHugo
  displayName: Download hugo and install it
  jobs:
  - job: DownloadAndInstallHugo
    pool:
      vmImage: $(vmImage)
    steps:
    - script: wget -c https://github.com/gohugoio/hugo/releases/download/v$(hugo.version)/hugo_$(hugo.version)_Linux-64bit.deb
      displayName: 'Download HUGO'
    - script: 'sudo dpkg -i hugo_$(hugo.version)_Linux-64bit.deb'
      displayName: 'Install HUGO'

- stage: CompileStaticAssets
  dependsOn:
    - DownloadAndInstallHugo
  displayName: Download NPM and install assets withs Gulp
  jobs:
  - job: CompileAssetsWithGulp
    pool:
      vmImage: $(vmImage)
    steps:
    - task: Npm@1
      inputs:
        command: 'install'
        workingDir: $(Pipeline.Workspace)/$(hugo.theme.path)
    - task: Gulp@1
      inputs:
        gulpFile: 'gulpfile.js'
        targets: 'compile'
        gulpjs: $(Pipeline.Workspace)/$(hugo.theme.path)
        enableCodeCoverage: false

- stage: Build
  dependsOn:
    - CompileStaticAssets
  displayName: Build Hugo blog
  jobs:
  - job: BuildHugoBlog
    pool:
      vmImage: $(vmImage)
    steps:
    - script: $(Pipeline.Workspace)/'HUGO_ENV=production hugo -v'
      displayName: 'Build HUGO blog'