# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

variables:
  gh_user: misky1986
  gh_repo: misky-blog  
  gh_email: mskydt86@gmail.com
  gh_auth_header: $(echo -n "${gh_user}:$(github_pat)" | base64);
  hugoVersion: '0.62.2'
  hugoThemePath: 'themes/mind-blown'
  vmImage: 'ubuntu-latest'
  tag: '$(Build.BuildNumber)'

stages:
- stage: CompileStaticAssets
  displayName: Install NPM packages and compile assets with Gulp
  jobs:
  - job: CompileAssetsWithGulp
    pool:
      vmImage: $(vmImage)
    steps:    
    - task: Npm@1
      inputs:
        command: 'install'
        workingDir: $(hugoThemePath)
    - task: Gulp@1
      inputs:
        gulpFile: $(hugoThemePath)/gulpfile.js
        targets: 'compile'
        enableCodeCoverage: false
    - publish: ./
      artifact: blogWithAssets

- stage: BuildBlog
  dependsOn:
    - CompileStaticAssets
  displayName: Build Hugo blog
  jobs:
  - job: BuildHugoBlog
    pool:
      vmImage: $(vmImage)
    steps:
    - checkout: none
    - download: current
      artifact: blogWithAssets
    - script: wget -c https://github.com/gohugoio/hugo/releases/download/v$(hugoVersion)/hugo_$(hugoVersion)_Linux-64bit.deb
      displayName: 'Download HUGO'
    - script: 'sudo dpkg -i hugo_$(hugoVersion)_Linux-64bit.deb'
      displayName: 'Install HUGO'
    - script: |
        cd $(Pipeline.Workspace)/blogWithAssets
        hugo
      displayName: 'Build HUGO blog'
    - publish: $(Pipeline.Workspace)/blogWithAssets/public
      artifact: misky-blog-build

- stage: DeployToGitHubPages
  dependsOn:
    - BuildBlog
  displayName: Deploy blog to Github pages
  jobs:
  - job: DeployBlogToGithubPages
    pool:
      vmImage: $(vmImage)
    steps:
    - checkout: none
    - download: current
      artifact: misky-blog-build
    - script: |
        cd $(Pipeline.Workspace)/misky-blog-build
        set -e # stop at first failing command
        git init
        git config --global user.email $(gh_email) > /dev/null 2>&1
        git config --global user.name $(gh_user) > /dev/null 2>&1
        git add .
        git commit -m "[Azure Pipeline] Deploy to ghpages branch from Deploy stage"
        git remote add origin git@github.com:$(gh_user)/$(gh_repo).git
        git push --force origin master:gh-pages